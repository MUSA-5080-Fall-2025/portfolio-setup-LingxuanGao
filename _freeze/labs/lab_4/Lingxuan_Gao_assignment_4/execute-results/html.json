{
  "hash": "c9b6c6a898101e436084dcb380e4021b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Assignment 4: Spatial Predictive Analysis\"\nauthor: \"Lingxuan Gao\"\ndate: Nov 13th\nformat:\n  html:\n    code-fold: true\n    code-tools: true\n    toc: true\n    toc-depth: 3\n    toc-location: left\n    theme: cosmo\n    embed-resources: true\neditor: visual\nexecute:\n  warning: false\n  message: false\n---\n\n# Overview\n\nIn this lab, I will apply the spatial predictive modeling techniques to the sanitation code complaints in Chicago during 2017.\n\n# Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(tidyverse)      # Data manipulation\nlibrary(sf)             # Spatial operations\nlibrary(here)           # Relative file paths\nlibrary(viridis)        # Color scales\nlibrary(terra)          # Raster operations (replaces 'raster')\nlibrary(spdep)          # Spatial dependence\nlibrary(FNN)            # Fast nearest neighbors\nlibrary(MASS)           # Negative binomial regression\nlibrary(patchwork)      # Plot composition (replaces grid/gridExtra)\nlibrary(knitr)          # Tables\nlibrary(kableExtra)     # Table formatting\nlibrary(classInt)       # Classification intervals\nlibrary(here)\n\n# Spatstat split into sub-packages\nlibrary(spatstat.geom)    # Spatial geometries\nlibrary(spatstat.explore) # Spatial exploration/KDE\n\n# Set options\noptions(scipen = 999)  # No scientific notation\nset.seed(5080)         # Reproducibility\n\n# Create consistent theme for visualizations\ntheme_crime <- function(base_size = 11) {\n  theme_minimal(base_size = base_size) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = base_size + 1),\n      plot.subtitle = element_text(color = \"gray30\", size = base_size - 1),\n      legend.position = \"right\",\n      panel.grid.minor = element_blank(),\n      axis.text = element_blank(),\n      axis.title = element_blank()\n    )\n}\n\n# Set as default\ntheme_set(theme_crime())\n```\n:::\n\n\n# Part 1: Data Loading & Exploration\n\n::: callout-note\nWhy I choose Sanitation Code Complaints as a Predictor?\n\n1.  **Visible Environmental Disorder**: Sanitation violations (illegal dumping, overflowing garbage, unsanitary conditions) are highly visible markers of neighborhood neglect that signal low social control and guardianship.\n\n2.  **Property Maintenance Connection**: Sanitation code violations often correlate with poorly maintained properties - the same conditions that make areas vulnerable to burglary.\n\n3.  **Temporal Stability**: Unlike some 311 calls that are seasonal, sanitation violations tend to persist, making them reliable indicators of chronic neighborhood conditions.\n\n**Expected Relationship**: I hypothesize a positive correlation between sanitation complaints and burglaries, where areas with higher sanitation violations will experience elevated burglary rates.\n:::\n\n## 1.1 Load 311 data: Sanitation Code Complaints in Chicago during 2017\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load sanitation code complaints\nsanitation_raw <- read_csv(here(\"data\", \"311_Service_Requests_-_Sanitation_Code_Complaints.csv\"))\n\n# Process and filter for 2017 only\nsanitation <- sanitation_raw %>%\n  # Parse the existing Creation Date column \n  mutate(creation_date = mdy(`Creation Date`)) %>%\n\n# Filter for 2017 only\n  filter(\n    year(creation_date) == 2017,\n    !is.na(Latitude), \n    !is.na(Longitude)\n  ) %>%\n  # Convert to spatial object\n  st_as_sf(coords = c(\"Longitude\", \"Latitude\"), crs = 4326) %>%\n  st_transform('ESRI:102271')\n```\n:::\n\n\n## 1.2 Load Burglary Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load from provided data file (downloaded from Chicago open data portal)\nburglaries <- st_read(here(\"data\", \"burglaries.shp\")) %>% \n  st_transform('ESRI:102271')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `burglaries' from data source \n  `D:\\MUSA\\MUSA_5080\\portfolio-setup-LingxuanGao\\data\\burglaries.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 7482 features and 22 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 340492 ymin: 552959.6 xmax: 367153.5 ymax: 594815.1\nProjected CRS: NAD83(HARN) / Illinois East\n```\n\n\n:::\n:::\n\n\n## 1.3 Load Chicago Spatial Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load police districts (used for spatial cross-validation)\npoliceDistricts <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(District = dist_num)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `OGRGeoJSON' from data source \n  `https://data.cityofchicago.org/api/geospatial/24zt-jpfn?method=export&format=GeoJSON' \n  using driver `GeoJSON'\nSimple feature collection with 25 features and 2 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -87.94011 ymin: 41.64455 xmax: -87.52414 ymax: 42.02303\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# Load police beats (smaller administrative units)\npoliceBeats <- \n  st_read(\"https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON\") %>%\n  st_transform('ESRI:102271') %>%\n  dplyr::select(Beat = beat_num)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `OGRGeoJSON' from data source \n  `https://data.cityofchicago.org/api/geospatial/n9it-hstw?method=export&format=GeoJSON' \n  using driver `GeoJSON'\nSimple feature collection with 277 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -87.94011 ymin: 41.64455 xmax: -87.52414 ymax: 42.02303\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# Load Chicago boundary\nchicagoBoundary <- \n  st_read(\"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\") %>%\n  st_transform('ESRI:102271')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `chicagoBoundary' from data source \n  `https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 1 feature and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -87.8367 ymin: 41.64454 xmax: -87.52414 ymax: 42.02304\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n\n## 1.4 The spatial distribution of Sanitation Code Complaints\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Simple point map\np1 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = sanitation, color = \"#d62828\", size = 0.1, alpha = 0.4) +\n  labs(\n    title = \"Sanitation Code Complaints\",\n    subtitle = paste0(\"Chicago 2017, n = \", nrow(sanitation))\n  )\n\n# Density surface using modern syntax\np2 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_density_2d_filled(\n    data = data.frame(st_coordinates(sanitation)),\n    aes(X, Y),\n    alpha = 0.7,\n    bins = 8\n  ) +\n  scale_fill_viridis_d(\n    option = \"plasma\",\n    direction = -1,\n    guide = \"none\"  # Modern ggplot2 syntax (not guide = FALSE)\n  ) +\n  labs(\n    title = \"Density Surface\",\n    subtitle = \"Kernel density estimation\"\n  )\n\n# Combine plots\np1 + p2 + \n  plot_annotation(\n    title = \"Sanitation Code Complaints\",\n    tag_levels = 'A'\n  )\n```\n\n::: {.cell-output-display}\n![](Lingxuan_Gao_assignment_4_files/figure-html/visualize-points1-1.png){width=960}\n:::\n:::\n\n\n**Spatial Pattern of Sanitation Complaints:**\n\nThe point pattern map (Figure A) reveals **highly clustered** sanitation complaints concentrated in Chicago's central and south-central corridors.This is not random distribution—kernel density estimation (Figure B). It identifies three distinct hot spots with peak densities in the mid-north, central-south, and southern districts.\n\n##1.5 The spatial distribution of Burglary\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Simple point map\np1 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = burglaries, color = \"#d62828\", size = 0.1, alpha = 0.4) +\n  labs(\n    title = \"Burglary Locations\",\n    subtitle = paste0(\"Chicago 2017, n = \", nrow(burglaries))\n  )\n\n# Density surface using modern syntax\np2 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_density_2d_filled(\n    data = data.frame(st_coordinates(burglaries)),\n    aes(X, Y),\n    alpha = 0.7,\n    bins = 8\n  ) +\n  scale_fill_viridis_d(\n    option = \"plasma\",\n    direction = -1,\n    guide = \"none\"  # Modern ggplot2 syntax (not guide = FALSE)\n  ) +\n  labs(\n    title = \"Density Surface\",\n    subtitle = \"Kernel density estimation\"\n  )\n\n# Combine plots using patchwork (modern approach)\np1 + p2 + \n  plot_annotation(\n    title = \"Spatial Distribution of Burglaries in Chicago\",\n    tag_levels = 'A'\n  )\n```\n\n::: {.cell-output-display}\n![](Lingxuan_Gao_assignment_4_files/figure-html/visualize-points2-1.png){width=960}\n:::\n:::\n\n\n**Spatial Patterns of Burglaries**\n\nBurglaries are **highly unevenly distributed** across Chicago. The point pattern map reveals dense concentrations forming continuous corridors through central and south-central districts, while northern and far southern edges show sparse activity. The kernel density surface identifies **three major hot spots**: a dominant mid-north concentration, a central-south band, and a southern cluster.\n\n# Part 2: Fishnet Grid Creation\n\n## 2.1 Fishnet Creation\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create 500m x 500m grid\nfishnet <- st_make_grid(\n  chicagoBoundary,\n  cellsize = 500,  # 500 meters per cell\n  square = TRUE\n) %>%\n  st_sf() %>%\n  mutate(uniqueID = row_number())\n\n# Keep only cells that intersect Chicago\nfishnet <- fishnet[chicagoBoundary, ]\n\n# View basic info\ninfo_tbl <- tibble::tibble(\n  Metric = c(\"Number of cells\", \"Cell size\", \"Cell area (m²)\"),\n  Value  = c(\n    scales::comma(nrow(fishnet)),\n    \"500 × 500 m\",\n    scales::comma(round(as.numeric(units::drop_units(sf::st_area(fishnet[1, ])))))\n  )\n)\n\nknitr::kable(\n  info_tbl,\n  caption   = \"Fishnet Summary\",\n  col.names = c(\"Metric\", \"Value\"),\n  align     = c(\"l\",\"r\"),\n  booktabs  = TRUE\n) |>\n  kableExtra::kable_styling(full_width = FALSE, position = \"left\",\n                            bootstrap_options = c(\"striped\",\"hover\",\"condensed\")) |>\n  kableExtra::column_spec(1, bold = TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; \">\n<caption>Fishnet Summary</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Metric </th>\n   <th style=\"text-align:right;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Number of cells </td>\n   <td style=\"text-align:right;\"> 2,458 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Cell size </td>\n   <td style=\"text-align:right;\"> 500 × 500 m </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Cell area (m²) </td>\n   <td style=\"text-align:right;\"> 250,000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## 2.2 Aggregate violations to grid cells\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Spatial join: which cell contains each burglary?\nburglaries_fishnet <- st_join(burglaries, fishnet, join = st_within) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(countBurglaries = n())\n\n# Join back to fishnet (cells with 0 burglaries will be NA)\nfishnet <- fishnet %>%\n  left_join(burglaries_fishnet, by = \"uniqueID\") %>%\n  mutate(countBurglaries = replace_na(countBurglaries, 0))\n\n# Compute summary statistics\nburglaries_sum<- summary(fishnet$countBurglaries)\n\n#Identify Zero-count cells\nbur_zero_n <- sum(fishnet$countBurglaries == 0)\nbur_zero_pct   <- 100 * bur_zero_n / nrow(fishnet)\n\n# Pull the six standard numeric summary fields in order\nfields <- c(\"Min.\", \"1st Qu.\", \"Median\", \"Mean\", \"3rd Qu.\", \"Max.\")\nvals <- round(as.numeric(burglaries_sum[fields]), 2)\n\n# Convert to character with two decimal places\nvals_fmt <- sprintf(\"%.2f\", vals)\n\n# Build final table\nsummary_tbl <- tibble::tibble(\n  Statistic = c(\n    \"Min\",\n    \"1st Quartile\",\n    \"Median\",\n    \"Mean\",\n    \"3rd Quartile\",\n    \"Max\",\n    \"Cells with zero Burglaries\"\n  ),\n  Value = c(\n    vals_fmt,\n    sprintf(\n      \"%s / %s (%.1f%%)\",\n      scales::comma(bur_zero_n),\n      scales::comma(nrow(fishnet)),\n      bur_zero_pct\n    )\n  )\n)\n\n# Render table\nknitr::kable(\n  summary_tbl,\n  caption = \"Summary of Burglaries Counts per Grid Cell\",\n  col.names = c(\"Statistic\", \"Value\"),\n  align = c(\"l\", \"r\"),\n  booktabs = TRUE\n) %>%\n  kableExtra::kable_styling(\n    bootstrap_options = c(\"striped\", \"hover\", \"condensed\"),\n    full_width = FALSE\n  )\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Summary of Burglaries Counts per Grid Cell</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Statistic </th>\n   <th style=\"text-align:right;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Min </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1st Quartile </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Median </td>\n   <td style=\"text-align:right;\"> 2.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Mean </td>\n   <td style=\"text-align:right;\"> 3.04 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3rd Quartile </td>\n   <td style=\"text-align:right;\"> 5.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Max </td>\n   <td style=\"text-align:right;\"> 40.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Cells with zero Burglaries </td>\n   <td style=\"text-align:right;\"> 781 / 2,458 (31.8%) </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Spatial join: which cell contains each sanitation complaints?\nsanitation_fishnet <- st_join(sanitation, fishnet, join = st_intersects) %>%\n  st_drop_geometry() %>%\n  group_by(uniqueID) %>%\n  summarize(countSanitation = n())\n\n# Join back to fishnet (cells with 0 sanitation complaints)\nfishnet <- fishnet %>%\n  left_join(sanitation_fishnet, by = \"uniqueID\") %>%\n  mutate(countSanitation = replace_na(countSanitation, 0))\n\n# Compute summary statistics\nsanitation_sum<- summary(fishnet$countSanitation)\n\n#Identify Zero-count cells\nsan_zero_n <- sum(fishnet$countSanitation == 0)\nsan_zero_pct   <- 100 * san_zero_n / nrow(fishnet)\n\n# Pull the six standard numeric summary fields in order\nfields <- c(\"Min.\", \"1st Qu.\", \"Median\", \"Mean\", \"3rd Qu.\", \"Max.\")\nvals <- round(as.numeric(sanitation_sum[fields]), 2)\n\n# Convert to character with two decimal places\nvals_fmt <- sprintf(\"%.2f\", vals)\n\n# Build final table\nsummary_tbl <- tibble::tibble(\n  Statistic = c(\n    \"Min\",\n    \"1st Quartile\",\n    \"Median\",\n    \"Mean\",\n    \"3rd Quartile\",\n    \"Max\",\n    \"Cells with zero sanitation complaints\"\n  ),\n  Value = c(\n    vals_fmt,\n    sprintf(\n      \"%s / %s (%.1f%%)\",\n      scales::comma(san_zero_n),\n      scales::comma(nrow(fishnet)),\n      san_zero_pct\n    )\n  )\n)\n\n# Render table\nknitr::kable(\n  summary_tbl,\n  caption = \"Summary of Sanitation Complaints Counts per Grid Cell\",\n  col.names = c(\"Statistic\", \"Value\"),\n  align = c(\"l\", \"r\"),\n  booktabs = TRUE\n) %>%\n  kableExtra::kable_styling(\n    bootstrap_options = c(\"striped\", \"hover\", \"condensed\"),\n    full_width = FALSE\n  )\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Summary of Sanitation Complaints Counts per Grid Cell</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Statistic </th>\n   <th style=\"text-align:right;\"> Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Min </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1st Quartile </td>\n   <td style=\"text-align:right;\"> 1.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Median </td>\n   <td style=\"text-align:right;\"> 5.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Mean </td>\n   <td style=\"text-align:right;\"> 8.02 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3rd Quartile </td>\n   <td style=\"text-align:right;\"> 12.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Max </td>\n   <td style=\"text-align:right;\"> 189.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Cells with zero sanitation complaints </td>\n   <td style=\"text-align:right;\"> 576 / 2,458 (23.4%) </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## 2.3 Count Distribution Visualiztion\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = countSanitation), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Count\", \n    option = \"plasma\",\n    trans = \"sqrt\", \n    breaks = c(0, 10, 20, 40, 80, 160)) +\n  labs(title = \"Sanitation Complaints\") +\n  theme_crime()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +\n  scale_fill_viridis_c(\n    name = \"Count\",\n    option = \"plasma\",\n    trans = \"sqrt\", \n    breaks = c(0, 1, 5, 10, 20, 40))+      \n  labs(title = \"Burglaries\") +\n  theme_crime()\n\np1 + p2 +\n  plot_annotation(title = \"Are sanitation complaints and burglaries correlated?\")\n```\n\n::: {.cell-output-display}\n![](Lingxuan_Gao_assignment_4_files/figure-html/visualize-fishnet-1.png){width=960}\n:::\n:::\n\n\n**Summary:**: Sanitation complaints and burglaries show broadly similar spatial patterns, with higher concentrations in central and denser parts of the city.\n\n# Part 3: Spatial Features\n\n## 3.1 K-Nearest Neighbor Features Calculation\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate mean distance to 3 nearest sanitation complaints\n\n# Extract centroids for fishnet cells\nfishnet_coords <- st_coordinates(st_centroid(fishnet))\n\n# Extract coordinates of sanitation complaints\nsanitation_coords <- st_coordinates(sanitation)\n\n# Compute 3 nearest graffiti neighbors for each grid cell\nnn_result <- get.knnx(sanitation_coords, fishnet_coords, k = 3)\n\n# Add feature to fishnet\nfishnet <- fishnet %>%\n  mutate(\n    sanitation_nn = rowMeans(nn_result$nn.dist)   # mean distance to 3 nearest sanitation complaints\n  )\n\n\nsummary(fishnet$sanitation_nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n   1.031  108.565  181.606  294.820  332.417 2213.320 \n```\n\n\n:::\n:::\n\n\n**Minimum: 1 meter**: Three different sanitation complaints requests occurred just one meter apart **1st Quartile: 108 meters**: 108 meters are about 2 minute walk. This means in 25% of Chicago’s grid cells, the nearest sanitation complaints are within 1 block. **Median: 181 meters**: Half of all grid cells have their three sanitation complaints within 2 blocks. **Mean: 295 meters**: The mean is much larger than the median, which reveals: Sanitation complaints is extremely skewed. **3rd Quartile: 332 meters**: Three-quarters of grid cells have their nearest neighbors within 332m (\\~4 city blocks). **Maximum: 2213 meters**: These are the sparsest parts of the city.\n\n##3.2 Perform Local Moran’s I analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Function unchanged\ncalculate_local_morans <- function(data, variable, k = 5) {\n\n# Create spatial weights  \n  coords <- st_coordinates(st_centroid(data))\n  neighbors <- knn2nb(knearneigh(coords, k = k))\n  weights <- nb2listw(neighbors, style = \"W\", zero.policy = TRUE)\n\n# Calculate Local Moran's I  \n  local_moran <- localmoran(data[[variable]], weights)\n  \n# Classify clusters\n  mean_val <- mean(data[[variable]], na.rm = TRUE)\n  \n  data %>%\n    mutate(\n      local_i = local_moran[, 1],\n      p_value = local_moran[, 5],\n      is_significant = p_value < 0.05,\n      \n      moran_class = case_when(\n        !is_significant ~ \"Not Significant\",\n        local_i > 0 & .data[[variable]] > mean_val ~ \"High-High\",\n        local_i > 0 & .data[[variable]] <= mean_val ~ \"Low-Low\",\n        local_i < 0 & .data[[variable]] > mean_val ~ \"High-Low\",\n        local_i < 0 & .data[[variable]] <= mean_val ~ \"Low-High\",\n        TRUE ~ \"Not Significant\"\n      )\n    )\n}\n\n# Apply to Sanitation Complaints counts\nfishnet <- calculate_local_morans(fishnet, \"countSanitation\", k = 5)\n```\n:::\n\n\n##3.3 Identify hot spots and cold spots\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(\n    data = fishnet,\n    aes(fill = moran_class),\n    color = NA\n  ) +\n  scale_fill_manual(\n    values = c(\n      \"High-High\" = \"#d7191c\",   # Red = hot spot\n      \"High-Low\" = \"#fdae61\",\n      \"Low-High\" = \"#abd9e9\",\n      \"Low-Low\" = \"#2c7bb6\",\n      \"Not Significant\" = \"gray90\"\n    ),\n    name = \"Cluster Type\"\n  ) +\n  labs(\n    title = \"Local Moran's I: Sanitation code complatins Clusters\",\n    subtitle = \"High-High = Hot spots of disorder\"\n  ) +\n  theme_crime()\n```\n\n::: {.cell-output-display}\n![](Lingxuan_Gao_assignment_4_files/figure-html/visualize-morans-sanitation-1.png){width=768}\n:::\n:::\n\n\nThis Local Moran’s I map shows that sanitation complaints are clustering.\n\n##3.4 Create distance-to-hotspot measures\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get centroids of \"High-High\" cells \nhotspots <- fishnet %>%\n  filter(moran_class == \"High-High\") %>%\n  st_centroid()\n\n# Calculate distance from each grid cell to hot spot\nif (nrow(hotspots) > 0) {\n  \n  fishnet <- fishnet %>%\n    mutate(\n      dist_to_hotspot = as.numeric(\n        st_distance(st_centroid(fishnet), hotspots %>% st_union())\n      )\n    )\n\n  cat(\"  - Number of hot spot cells:\", nrow(hotspots), \"\\n\")\n  \n} else {\n  \n  fishnet <- fishnet %>%\n    mutate(dist_to_hotspot = 0)\n  \n  cat(\"⚠ No significant graffiti hot spots found\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Number of hot spot cells: 203 \n```\n\n\n:::\n:::\n\n\n# Part 4: Count Regression Models\n\nI’ll use police districts for the spatial cross-validation.\n\n## 4.1 Join district information to fishnet\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet <- st_join(\n  fishnet,\n  policeDistricts,\n  join = st_within,\n  left = TRUE\n) %>%\n  filter(!is.na(District))  # Remove cells outside districts\n\ncat(\"  - Districts:\", length(unique(fishnet$District)), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Districts: 22 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Cells:\", nrow(fishnet), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Cells: 1708 \n```\n\n\n:::\n:::\n\n\n## 4.2 Fit Poisson regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfishnet_model <- fishnet %>%\n  st_drop_geometry() %>%\n  dplyr::select(\n    uniqueID,\n    District,\n    countBurglaries,\n    countSanitation,\n    sanitation_nn,\n    dist_to_hotspot\n  ) %>%\n  na.omit()  # Remove any remaining NAs\n\ncat(\"  - Observations:\", nrow(fishnet_model), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Observations: 1708 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Variables:\", ncol(fishnet_model), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Variables: 6 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_poisson <- glm(\n  countBurglaries ~ countSanitation + sanitation_nn + \n    dist_to_hotspot,\n  data = fishnet_model,\n  family = \"poisson\"\n)\n\n# Summary\nsummary(model_poisson)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = countBurglaries ~ countSanitation + sanitation_nn + \n    dist_to_hotspot, family = \"poisson\", data = fishnet_model)\n\nCoefficients:\n                   Estimate  Std. Error z value            Pr(>|z|)    \n(Intercept)      2.22791188  0.03593051  62.006 <0.0000000000000002 ***\ncountSanitation  0.00264490  0.00107409   2.462              0.0138 *  \nsanitation_nn   -0.00449200  0.00017766 -25.284 <0.0000000000000002 ***\ndist_to_hotspot -0.00014657  0.00001029 -14.243 <0.0000000000000002 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 6710.3  on 1707  degrees of freedom\nResidual deviance: 4058.3  on 1704  degrees of freedom\nAIC: 8126.6\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n:::\n\n\n**Interpretation**: The model predicts burglary counts based on three sanitation-related features: countSanitation — how many sanitation complaints fall inside a grid cell sanitation_nn — average distance to the 3 nearest sanitation complaints dist_to_hotspot — distance to a sanitation hotspot (cluster of complaints)\n\nThe coefficient of countSanitation is positive. Each additional sanitation complaint inside a cell is linked to a 0.26% increase in expected burglaries.\n\nThe coefficient of sanitation_nn is Very strong negative. For each additional meter farther away from sanitation complaints, expected burglaries drop by about 0.45%.\n\nThe coefficient of dist_to_hotspot is slightly negative, which means being farther from a sanitation hotspot is linked to slightly fewer burglaries.\n\nAll three predictors are statistically significant.\n\nIn conclusion, Burglary risk rises in places where sanitation complaints are concentrated or close by.\n\n##4.3 Check for Overdispersion\n\nPoisson regression assumes mean = variance. Real count data often violates this (overdispersion).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate dispersion parameter\ndispersion <- sum(residuals(model_poisson, type = \"pearson\")^2) / \n              model_poisson$df.residual\n\ncat(\"Dispersion parameter:\", round(dispersion, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDispersion parameter: 2.55 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Rule of thumb: >1.5 suggests overdispersion\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRule of thumb: >1.5 suggests overdispersion\n```\n\n\n:::\n\n```{.r .cell-code}\nif (dispersion > 1.5) {\n  cat(\"⚠ Overdispersion detected! Consider Negative Binomial model.\\n\")\n} else {\n  cat(\"Dispersion looks okay for Poisson model.\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n⚠ Overdispersion detected! Consider Negative Binomial model.\n```\n\n\n:::\n:::\n\n\n##4.4 Negative Binomial Regression\n\nIf overdispersed, use **Negative Binomial regression** (more flexible).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit Negative Binomial model\nmodel_nb <- glm.nb(\n  countBurglaries ~ countSanitation + sanitation_nn + \n    dist_to_hotspot,\n  data = fishnet_model\n)\n\n# Summary\nsummary(model_nb)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm.nb(formula = countBurglaries ~ countSanitation + sanitation_nn + \n    dist_to_hotspot, data = fishnet_model, init.theta = 2.396013291, \n    link = log)\n\nCoefficients:\n                   Estimate  Std. Error z value            Pr(>|z|)    \n(Intercept)      2.26736511  0.06167510  36.763 <0.0000000000000002 ***\ncountSanitation  0.00338981  0.00207473   1.634               0.102    \nsanitation_nn   -0.00483437  0.00025537 -18.931 <0.0000000000000002 ***\ndist_to_hotspot -0.00014469  0.00001548  -9.345 <0.0000000000000002 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for Negative Binomial(2.396) family taken to be 1)\n\n    Null deviance: 3091.5  on 1707  degrees of freedom\nResidual deviance: 1783.9  on 1704  degrees of freedom\nAIC: 7151.4\n\nNumber of Fisher Scoring iterations: 1\n\n              Theta:  2.396 \n          Std. Err.:  0.154 \n\n 2 x log-likelihood:  -7141.431 \n```\n\n\n:::\n:::\n\n\n##4.5 Compare model fit (AIC)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compare AIC (lower is better)\ncat(\"\\nModel Comparison:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nModel Comparison:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Poisson AIC:\", round(AIC(model_poisson), 1), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPoisson AIC: 8126.6 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Negative Binomial AIC:\", round(AIC(model_nb), 1), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNegative Binomial AIC: 7151.4 \n```\n\n\n:::\n:::\n\n\n**Negative Binomial Model Interpretation**: The negative binomial model fits the data much better than the Poisson model (AIC drops from 8126 → 7151), which tells us burglary counts are overdispersed. Cells that are closer to sanitation complaints (sanitation_nn) show higher burglary risk. The coefficient is strongly negative and highly significant, meaning risk increases as distance shrinks. The same pattern appears with distance to sanitation hotspots: burglary rates are higher near clusters of sanitation complaints. The within-cell count of sanitation complaints (countSanitation) becomes non-significant once distance features are included, suggesting that proximity to disorder matters more than simple counts inside a grid cell.\n\n# Part 5: Spatial Cross-Validation\n\nStandard cross-validation randomly splits data. But with spatial data, this means training on cells right next to test cells (information leakage!). **Leave-One-Group-Out (LOGO) Cross-Validation** trains on all districts except one, then tests on the held-out district. So I’ll use Leave-One-Group-Out (LOGO) Cross-Validation to train the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get unique districts\ndistricts <- unique(fishnet_model$District)\ncv_results <- tibble()\n\nfor (i in seq_along(districts)) {\n  \n  test_district <- districts[i]\n  \n  # Split data\n  train_data <- fishnet_model %>% filter(District != test_district)\n  test_data <- fishnet_model %>% filter(District == test_district)\n  \n  # Fit model on training data\n  model_cv <- glm.nb(\n    countBurglaries ~ countSanitation + sanitation_nn + \n      dist_to_hotspot,\n    data = train_data\n  )\n  \n  # Predict on test data\n  test_data <- test_data %>%\n    mutate(\n      prediction = predict(model_cv, test_data, type = \"response\")\n    )\n  \n  # Calculate metrics\n  mae <- mean(abs(test_data$countBurglaries - test_data$prediction))\n  rmse <- sqrt(mean((test_data$countBurglaries - test_data$prediction)^2))\n  \n  # Store results\n  cv_results <- bind_rows(\n    cv_results,\n    tibble(\n      fold = i,\n      test_district = test_district,\n      n_test = nrow(test_data),\n      mae = mae,\n      rmse = rmse\n    )\n  )\n  \n}\n\n# Overall results\ncat(\"Mean MAE:\", round(mean(cv_results$mae), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean MAE: 2.51 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean RMSE:\", round(mean(cv_results$rmse), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean RMSE: 3.35 \n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Show results\ncv_results %>%\n  arrange(desc(mae)) %>%\n  kable(\n    digits = 2,\n    caption = \"LOGO CV Results by District\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>LOGO CV Results by District</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> fold </th>\n   <th style=\"text-align:left;\"> test_district </th>\n   <th style=\"text-align:right;\"> n_test </th>\n   <th style=\"text-align:right;\"> mae </th>\n   <th style=\"text-align:right;\"> rmse </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> 3 </td>\n   <td style=\"text-align:right;\"> 43 </td>\n   <td style=\"text-align:right;\"> 5.22 </td>\n   <td style=\"text-align:right;\"> 7.10 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 15 </td>\n   <td style=\"text-align:left;\"> 18 </td>\n   <td style=\"text-align:right;\"> 30 </td>\n   <td style=\"text-align:right;\"> 3.57 </td>\n   <td style=\"text-align:right;\"> 4.65 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 14 </td>\n   <td style=\"text-align:left;\"> 11 </td>\n   <td style=\"text-align:right;\"> 43 </td>\n   <td style=\"text-align:right;\"> 3.00 </td>\n   <td style=\"text-align:right;\"> 3.61 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 12 </td>\n   <td style=\"text-align:left;\"> 12 </td>\n   <td style=\"text-align:right;\"> 73 </td>\n   <td style=\"text-align:right;\"> 2.93 </td>\n   <td style=\"text-align:right;\"> 4.07 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 17 </td>\n   <td style=\"text-align:left;\"> 14 </td>\n   <td style=\"text-align:right;\"> 46 </td>\n   <td style=\"text-align:right;\"> 2.91 </td>\n   <td style=\"text-align:right;\"> 3.82 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 21 </td>\n   <td style=\"text-align:left;\"> 20 </td>\n   <td style=\"text-align:right;\"> 30 </td>\n   <td style=\"text-align:right;\"> 2.71 </td>\n   <td style=\"text-align:right;\"> 3.18 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> 6 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> 2.70 </td>\n   <td style=\"text-align:right;\"> 3.98 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 18 </td>\n   <td style=\"text-align:left;\"> 19 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> 2.67 </td>\n   <td style=\"text-align:right;\"> 3.25 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 16 </td>\n   <td style=\"text-align:left;\"> 25 </td>\n   <td style=\"text-align:right;\"> 85 </td>\n   <td style=\"text-align:right;\"> 2.64 </td>\n   <td style=\"text-align:right;\"> 3.54 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 22 </td>\n   <td style=\"text-align:left;\"> 24 </td>\n   <td style=\"text-align:right;\"> 41 </td>\n   <td style=\"text-align:right;\"> 2.55 </td>\n   <td style=\"text-align:right;\"> 3.06 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> 7 </td>\n   <td style=\"text-align:right;\"> 52 </td>\n   <td style=\"text-align:right;\"> 2.44 </td>\n   <td style=\"text-align:right;\"> 3.08 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> 2 </td>\n   <td style=\"text-align:right;\"> 56 </td>\n   <td style=\"text-align:right;\"> 2.43 </td>\n   <td style=\"text-align:right;\"> 3.24 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> 10 </td>\n   <td style=\"text-align:right;\"> 63 </td>\n   <td style=\"text-align:right;\"> 2.32 </td>\n   <td style=\"text-align:right;\"> 2.97 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 20 </td>\n   <td style=\"text-align:left;\"> 17 </td>\n   <td style=\"text-align:right;\"> 82 </td>\n   <td style=\"text-align:right;\"> 2.24 </td>\n   <td style=\"text-align:right;\"> 2.79 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> 8 </td>\n   <td style=\"text-align:right;\"> 197 </td>\n   <td style=\"text-align:right;\"> 2.19 </td>\n   <td style=\"text-align:right;\"> 3.32 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> 22 </td>\n   <td style=\"text-align:right;\"> 112 </td>\n   <td style=\"text-align:right;\"> 2.04 </td>\n   <td style=\"text-align:right;\"> 2.61 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 11 </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:right;\"> 28 </td>\n   <td style=\"text-align:right;\"> 2.04 </td>\n   <td style=\"text-align:right;\"> 2.53 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 13 </td>\n   <td style=\"text-align:left;\"> 15 </td>\n   <td style=\"text-align:right;\"> 32 </td>\n   <td style=\"text-align:right;\"> 2.02 </td>\n   <td style=\"text-align:right;\"> 2.38 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> 5 </td>\n   <td style=\"text-align:right;\"> 98 </td>\n   <td style=\"text-align:right;\"> 2.00 </td>\n   <td style=\"text-align:right;\"> 2.96 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:left;\"> 9 </td>\n   <td style=\"text-align:right;\"> 107 </td>\n   <td style=\"text-align:right;\"> 1.79 </td>\n   <td style=\"text-align:right;\"> 2.39 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 19 </td>\n   <td style=\"text-align:left;\"> 16 </td>\n   <td style=\"text-align:right;\"> 129 </td>\n   <td style=\"text-align:right;\"> 1.57 </td>\n   <td style=\"text-align:right;\"> 2.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> 4 </td>\n   <td style=\"text-align:right;\"> 235 </td>\n   <td style=\"text-align:right;\"> 1.31 </td>\n   <td style=\"text-align:right;\"> 3.21 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n**Interpretation of the LOGO Cross-Validation Results** The table shows how well the model predicts burglaries when each police district is held out as completely unseen test data.MAE is average error in burglary counts per grid cell and RMSE is penalizes larger errors.\n\nAcross districts, MAE falls roughly between 1.3 and 5 burglaries, which means the model usually misses the true count by only a couple of events per cell. Districts with a large number of test cells (for example District 4 or 8) tend to have lower errors, because the model has more stable patterns to learn from. Districts with small or unusual spatial patterns, like District 3 or 18, show higher error, suggesting their burglary patterns don't generalize well from the rest of the city.\n\nOverall, the model generalizes reasonably well across space: performance varies by district, but prediction error stays within a narrow range\n\n# Part6: Model Evaluation\n\n##6.1 Create a Kernel Density Baseline This part builds a KDE hotspot baseline—my simplest prediction model, so I can later test whether complex regression models truly improve on “crime happens where it happened before.\n\n**The KDE baseline asks:** “What if crime just happens where it happened before?” (simple spatial smoothing, no predictors)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert burglaries to ppp (point pattern) format for spatstat\nburglaries_ppp <- as.ppp(\n  st_coordinates(burglaries),\n  W = as.owin(st_bbox(chicagoBoundary))\n)\n\n# Calculate KDE with 1km bandwidth\nkde_burglaries <- density.ppp(\n  burglaries_ppp,\n  sigma = 1000,  # 1km bandwidth\n  edge = TRUE    # Edge correction\n)\n\n# Convert to terra raster (modern approach, not raster::raster)\nkde_raster <- rast(kde_burglaries)\n\n# Extract KDE values to fishnet cells\nfishnet <- fishnet %>%\n  mutate(\n    kde_value = terra::extract(\n      kde_raster,\n      vect(fishnet),\n      fun = mean,\n      na.rm = TRUE\n    )[, 2]  # Extract just the values column\n  )\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = kde_value), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 1) +\n  scale_fill_viridis_c(\n    name = \"KDE Value\",\n    option = \"plasma\"\n  ) +\n  labs(\n    title = \"Kernel Density Estimation Baseline\",\n    subtitle = \"Simple spatial smoothing of burglary locations\"\n  ) +\n  theme_crime()\n```\n\n::: {.cell-output-display}\n![](Lingxuan_Gao_assignment_4_files/figure-html/visualize-kde-1.png){width=768}\n:::\n:::\n\n\n##6.2 Generate Final Predictions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit final model on all data\nfinal_model <- glm.nb(\n  countBurglaries ~ countSanitation + sanitation_nn + \n    dist_to_hotspot,\n  data = fishnet_model\n)\n\n# Add predictions back to fishnet\nfishnet <- fishnet %>%\n  mutate(\n    prediction_nb = predict(final_model, fishnet_model, type = \"response\")[match(uniqueID, fishnet_model$uniqueID)]\n  )\n\n# Also add KDE predictions (normalize to same scale as counts)\nkde_sum <- sum(fishnet$kde_value, na.rm = TRUE)\ncount_sum <- sum(fishnet$countBurglaries, na.rm = TRUE)\nfishnet <- fishnet %>%\n  mutate(\n    prediction_kde = (kde_value / kde_sum) * count_sum\n  )\n```\n:::\n\n\n##6.3 Compare Model vs. KDE Baseline\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create three maps\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = countBurglaries), color = NA) +\n  scale_fill_viridis_c(name = \"Count\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"Actual Burglaries\") +\n  theme_crime()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"Model Predictions (Neg. Binomial)\") +\n  theme_crime()\n\np3 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = prediction_kde), color = NA) +\n  scale_fill_viridis_c(name = \"Predicted\", option = \"plasma\", limits = c(0, 15)) +\n  labs(title = \"KDE Baseline Predictions\") +\n  theme_crime()\n\np1 + p2 + p3 +\n  plot_annotation(\n    title = \"Actual vs. Predicted Burglaries\",\n    subtitle = \"Does our complex model outperform simple KDE?\"\n  )\n```\n\n::: {.cell-output-display}\n![](Lingxuan_Gao_assignment_4_files/figure-html/compare-models-1.png){width=1152}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate performance metrics\ncomparison <- fishnet %>%\n  st_drop_geometry() %>%\n  filter(!is.na(prediction_nb), !is.na(prediction_kde)) %>%\n  summarize(\n    model_mae = mean(abs(countBurglaries - prediction_nb)),\n    model_rmse = sqrt(mean((countBurglaries - prediction_nb)^2)),\n    kde_mae = mean(abs(countBurglaries - prediction_kde)),\n    kde_rmse = sqrt(mean((countBurglaries - prediction_kde)^2))\n  )\n\ncomparison %>%\n  pivot_longer(everything(), names_to = \"metric\", values_to = \"value\") %>%\n  separate(metric, into = c(\"approach\", \"metric\"), sep = \"_\") %>%\n  pivot_wider(names_from = metric, values_from = value) %>%\n  kable(\n    digits = 2,\n    caption = \"Model Performance Comparison\"\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Model Performance Comparison</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> approach </th>\n   <th style=\"text-align:right;\"> mae </th>\n   <th style=\"text-align:right;\"> rmse </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> model </td>\n   <td style=\"text-align:right;\"> 2.21 </td>\n   <td style=\"text-align:right;\"> 3.27 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> kde </td>\n   <td style=\"text-align:right;\"> 2.06 </td>\n   <td style=\"text-align:right;\"> 2.95 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n**Interpretation**: The comparison shows that the Negative Binomial model does not outperform a simple KDE baseline.\n\nBecause burglary risk in Chicago is strongly path-dependent: the best predictor of where crime will occur is simply where it has occurred before. Adding sanitation-based disorder features does not increase predictive accuracy and may introduce noise.\n\nAlthough KDE outperforms the regression model in predictive accuracy, the regression model provides interpretive insight into how sanitation-related disorder correlates with burglary risk. KDE captures spatial inertia, whereas the model reveals underlying mechanisms.\n\nKDE is a better predictor, but the model is a better explanation.\n\n##6.4 Where Does the Model Work Well?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate errors\nfishnet <- fishnet %>%\n  mutate(\n    error_nb = countBurglaries - prediction_nb,\n    error_kde = countBurglaries - prediction_kde,\n    abs_error_nb = abs(error_nb),\n    abs_error_kde = abs(error_kde)\n  )\n\n# Map errors\np1 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = error_nb), color = NA) +\n  scale_fill_gradient2(\n    name = \"Error\",\n    low = \"#2166ac\", mid = \"white\", high = \"#b2182b\",\n    midpoint = 0,\n    limits = c(-10, 10)\n  ) +\n  labs(title = \"Model Errors (Actual - Predicted)\") +\n  theme_crime()\n\np2 <- ggplot() +\n  geom_sf(data = fishnet, aes(fill = abs_error_nb), color = NA) +\n  scale_fill_viridis_c(name = \"Abs. Error\", option = \"magma\") +\n  labs(title = \"Absolute Model Errors\") +\n  theme_crime()\n\np1 + p2\n```\n\n::: {.cell-output-display}\n![](Lingxuan_Gao_assignment_4_files/figure-html/prediction-errors-1.png){width=960}\n:::\n:::\n\n\n**Interpretation**: On the left, red cells indicate under-prediction—places where actual burglaries were higher than the model expected, while blue cells show over-prediction. Both colors appear scattered rather than clustered, which suggests no strong systematic spatial bias: the model isn’t consistently wrong in one part of the city.\n\nThe right map shows the absolute size of errors, highlighting where the model misses by larger margins. The largest errors occur in a few high-activity pockets, mostly in the South Side and near the West Side burglary clusters. This implies that the hardest places to predict are exactly the areas with the most burglary volatility.\n\n#Part7: Summary Statistics and Tables\n\n##7.1 Model Summary Table\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create nice summary table\nmodel_summary <- broom::tidy(final_model, exponentiate = TRUE) %>%\n  mutate(\n    across(where(is.numeric), ~round(., 3))\n  )\n\nmodel_summary %>%\n  kable(\n    caption = \"Final Negative Binomial Model Coefficients (Exponentiated)\",\n    col.names = c(\"Variable\", \"Rate Ratio\", \"Std. Error\", \"Z\", \"P-Value\")\n  ) %>%\n  kable_styling(bootstrap_options = c(\"striped\", \"hover\")) %>%\n  footnote(\n    general = \"Rate ratios > 1 indicate positive association with burglary counts.\"\n  )\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover\" style=\"margin-left: auto; margin-right: auto;border-bottom: 0;\">\n<caption>Final Negative Binomial Model Coefficients (Exponentiated)</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Variable </th>\n   <th style=\"text-align:right;\"> Rate Ratio </th>\n   <th style=\"text-align:right;\"> Std. Error </th>\n   <th style=\"text-align:right;\"> Z </th>\n   <th style=\"text-align:right;\"> P-Value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> 9.654 </td>\n   <td style=\"text-align:right;\"> 0.062 </td>\n   <td style=\"text-align:right;\"> 36.763 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> countSanitation </td>\n   <td style=\"text-align:right;\"> 1.003 </td>\n   <td style=\"text-align:right;\"> 0.002 </td>\n   <td style=\"text-align:right;\"> 1.634 </td>\n   <td style=\"text-align:right;\"> 0.102 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> sanitation_nn </td>\n   <td style=\"text-align:right;\"> 0.995 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> -18.931 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dist_to_hotspot </td>\n   <td style=\"text-align:right;\"> 1.000 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n   <td style=\"text-align:right;\"> -9.345 </td>\n   <td style=\"text-align:right;\"> 0.000 </td>\n  </tr>\n</tbody>\n<tfoot>\n<tr><td style=\"padding: 0; \" colspan=\"100%\"><span style=\"font-style: italic;\">Note: </span></td></tr>\n<tr><td style=\"padding: 0; \" colspan=\"100%\">\n<sup></sup> Rate ratios &gt; 1 indicate positive association with burglary counts.</td></tr>\n</tfoot>\n</table>\n\n`````\n:::\n:::\n\n",
    "supporting": [
      "Lingxuan_Gao_assignment_4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}